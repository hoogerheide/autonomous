<head>
    <script src="lib/jquery-3.7.1.min.js"></script>
    <script src="lib/plotly-2.27.0.min.js" charset="utf-8"></script>
    <script type="module">
        import { io } from "https://cdn.socket.io/4.7.4/socket.io.esm.min.js";

        const socket = io();
        var current_step_progress;
        var plotdata;

        function clear() {
            $("#fit_progress").empty();
            $("#queue_text").empty();
            new_step('init', '')
        }

        function new_step(stepnum, text) {
            let current_step = $("<div id=step_" + stepnum + " class='fit-step'></div>").text(text);
            current_step_progress = $("<div id=step_" + stepnum + "_progress class='fit-step-progress grid-fit-progress-text'></div>");
            current_step.append(current_step_progress);
            $("#fit_progress").prepend(current_step);
        }

        socket.on("connect", function () {
            $("#connect_monitor").text("Connected")
                         .addClass("titletext-connected")
                         .removeClass("titletext-disconnected")
            //socket.emit('get_history', null)
        })

        socket.on("disconnect", function () {
            $("#connect_monitor").text('Disconnected')
                         .removeClass("titletext-connected")
                         .addClass("titletext-disconnected")
            //console.log('Disconnected')
        })

        socket.on("queue_update", data => {
            $("#queue_text .measurement-pending").addClass("measurement-skipped").removeClass("measurement-pending");
            // Process queue data into table
            const headerinfo = {'model': 'Model', 'x': 'x', 'intent': 'Intent', 'time': 'Time'}
            var header = $('<tr>')
            Object.values(headerinfo).forEach(v => {
                header.append($('<th>').text(v))
            })
            var newtable = $('<table class="queue-table">').append(header)
            Object.values(data).forEach(q => {
                var newrow = $('<tr id=point_' + q['step_id'] + '_' + q['point_id'] + '_' + q['point_index'] + ' class="measurement-pending">')
                Object.keys(headerinfo).forEach(k => {
                    newrow.append($('<td>').text(q[k]))
                })
                newtable.append(newrow)
            })
            $("#queue_text").prepend(newtable)
        })

        socket.on("set_current_measurement", data => {
            $("#queue_text .measurement-current").addClass("measurement-done").removeClass("measurement-current");
            $('#' + data).addClass("measurement-current").removeClass("measurement-pending measurement-skipped")
        })

        socket.on("clear", data => {
            //console.log(data)
            clear()
        })

        socket.on("new_step", data => {
            $("#fit_progress .fit-step-progress").addClass("fit-inactive").removeClass("fit-step-progress")
            //$("#fit_progress").prepend("<hr>")
            new_step(data['step'], data['text'])
        })

        socket.on("fit_update", data => {
            //console.log(data)
            current_step_progress.prepend(data + "<br>")
        })

        var CB_color_cycle = ['#377eb8', '#ff7f00', '#4daf4a',
                  '#f781bf', '#a65628', '#984ea3',
                  '#999999', '#e41a1c', '#dede00']
        
        function makePlot(data) {
            var traces = [];
            Object.values(data['data']).forEach((ptdata, idx) => {
                traces.push({
                    x: ptdata['x'],
                    y: ptdata['v'],
                    error_y: {
                        type: 'data',
                        array: ptdata['dv'],
                        visible: true
                    },
                    line: {
                        color: CB_color_cycle[idx]
                    },
                    showlegend: false,
                    name: 'model ' + idx,
                    mode: 'markers',
                    type: 'scatter'
                })
            })
            Object.values(data['ci']).forEach((ptdata, idx) => {
                traces.push({
                    x: ptdata['x'],
                    y: ptdata['68']['lower'],
                    line: {
                        width: 0,
                    },
                    showlegend: false,
                    hoverinfo: 'none',
                    type: 'scatter',
                    mode: 'lines'
                });
                traces.push({
                    x: ptdata['x'],
                    y: ptdata['68']['upper'],
                    fill: 'tonexty',
                    fillcolor: CB_color_cycle[idx] + '44',
                    line: {
                        width: 0,
                    },
                    showlegend: false,
                    hoverinfo: 'none',
                    type: 'scatter',
                    mode: 'lines'
                });
                traces.push({
                    x: ptdata['x'],
                    y: ptdata['95']['lower'],
                    showlegend: false,
                    line: {
                        width: 0,
                    },
                    hoverinfo: 'none',
                    type: 'scatter',
                    mode: 'lines'
                });
                traces.push({
                    x: ptdata['x'],
                    y: ptdata['95']['upper'],
                    fill: 'tonexty',
                    fillcolor: CB_color_cycle[idx] + '44',
                    showlegend: false,
                    line: {
                        width: 0,
                    },
                    hoverinfo: 'none',
                    type: 'scatter',
                    mode: 'lines'
                });
            })
            return traces
        }

        function reset_plotdata() {
            plotdata = {'data': [], 'ci': []};
        };

        socket.on("update_plot", data => {
            let newdata = JSON.parse(data)
            plotdata = {...plotdata, ...newdata}
            //console.log(plotdata)
            var traces = makePlot(plotdata)
            var layout = {} //{'annotationdefaults': {'arrowcolor': '#2a3f5f', 'arrowhead': 0, 'arrowwidth': 1}, 'autotypenumbers': 'strict', 'coloraxis': {'colorbar': {'outlinewidth': 0, 'ticks': ''}}, 'colorscale': {'diverging': [[0, '#8e0152'], [0.1, '#c51b7d'], [0.2, '#de77ae'], [0.3, '#f1b6da'], [0.4, '#fde0ef'], [0.5, '#f7f7f7'], [0.6, '#e6f5d0'], [0.7, '#b8e186'], [0.8, '#7fbc41'], [0.9, '#4d9221'], [1, '#276419']], 'sequential': [[0.0, '#0d0887'], [0.1111111111111111, '#46039f'], [0.2222222222222222, '#7201a8'], [0.3333333333333333, '#9c179e'], [0.4444444444444444, '#bd3786'], [0.5555555555555556, '#d8576b'], [0.6666666666666666, '#ed7953'], [0.7777777777777778, '#fb9f3a'], [0.8888888888888888, '#fdca26'], [1.0, '#f0f921']], 'sequentialminus': [[0.0, '#0d0887'], [0.1111111111111111, '#46039f'], [0.2222222222222222, '#7201a8'], [0.3333333333333333, '#9c179e'], [0.4444444444444444, '#bd3786'], [0.5555555555555556, '#d8576b'], [0.6666666666666666, '#ed7953'], [0.7777777777777778, '#fb9f3a'], [0.8888888888888888, '#fdca26'], [1.0, '#f0f921']]}, 'colorway': ['#636efa', '#EF553B', '#00cc96', '#ab63fa', '#FFA15A', '#19d3f3', '#FF6692', '#B6E880', '#FF97FF', '#FECB52'], 'font': {'color': '#2a3f5f'}, 'geo': {'bgcolor': 'white', 'lakecolor': 'white', 'landcolor': 'white', 'showlakes': true, 'showland': true, 'subunitcolor': '#C8D4E3'}, 'hoverlabel': {'align': 'left'}, 'hovermode': 'closest', 'mapbox': {'style': 'light'}, 'paper_bgcolor': 'white', 'plot_bgcolor': 'white', 'polar': {'angularaxis': {'gridcolor': '#EBF0F8', 'linecolor': '#EBF0F8', 'ticks': ''}, 'bgcolor': 'white', 'radialaxis': {'gridcolor': '#EBF0F8', 'linecolor': '#EBF0F8', 'ticks': ''}}, 'scene': {'xaxis': {'backgroundcolor': 'white', 'gridcolor': '#DFE8F3', 'gridwidth': 2, 'linecolor': '#EBF0F8', 'showbackground': true, 'ticks': '', 'zerolinecolor': '#EBF0F8'}, 'yaxis': {'backgroundcolor': 'white', 'gridcolor': '#DFE8F3', 'gridwidth': 2, 'linecolor': '#EBF0F8', 'showbackground': true, 'ticks': '', 'zerolinecolor': '#EBF0F8'}, 'zaxis': {'backgroundcolor': 'white', 'gridcolor': '#DFE8F3', 'gridwidth': 2, 'linecolor': '#EBF0F8', 'showbackground': true, 'ticks': '', 'zerolinecolor': '#EBF0F8'}}, 'shapedefaults': {'line': {'color': '#2a3f5f'}}, 'ternary': {'aaxis': {'gridcolor': '#DFE8F3', 'linecolor': '#A2B1C6', 'ticks': ''}, 'baxis': {'gridcolor': '#DFE8F3', 'linecolor': '#A2B1C6', 'ticks': ''}, 'bgcolor': 'white', 'caxis': {'gridcolor': '#DFE8F3', 'linecolor': '#A2B1C6', 'ticks': ''}}, 'title': {'x': 0.05}, 'xaxis': {'automargin': true, 'gridcolor': '#EBF0F8', 'linecolor': '#EBF0F8', 'ticks': '', 'title': {'standoff': 15}, 'zerolinecolor': '#EBF0F8', 'zerolinewidth': 2}, 'yaxis': {'automargin': true, 'gridcolor': '#EBF0F8', 'linecolor': '#EBF0F8', 'ticks': '', 'title': {'standoff': 15}, 'zerolinecolor': '#EBF0F8', 'zerolinewidth': 2}}
            layout = {...layout, ...{
                yaxis: {type: 'log',
                        showexponent: 'all',
                        exponentformat: 'power',
                        autorange: true,
                        title: {
                            text: 'reflectivity',
                        }},
                xaxis: {title: {
                            text: 'Q',
                }},
                margin: {
                    l: 50,
                    b: 50,
                    t: 25,
                    r: 25,
                    autoexpand: true
                },
                plot_bgcolor:"#FFFFFF44",
                paper_bgcolor:"#FFFFFF00"

            }}
            Plotly.newPlot('plot', traces, layout)
        })

        $(document).ready(function () {
            clear()
            reset_plotdata()
        })
    </script>
    <style>
        div {
            font-family: sans-serif;
            box-sizing: border-box;
            /*white-space: pre-wrap;*/
        }
        .queue-table {
            border-collapse: collapse;
            border: 2px solid black;
            background-color: white;
            width: 100%;
            padding: 8px;
            margin: 8px;
        }
        tr {
            border: 1px solid black;
        }
        td {
            border: 1px solid black;
        }
        th {
            background-color: rgb(67, 140, 104);
            color:white;
            border: 1px solid black;
        }
        .bigtitletext{
            font-size: xx-large;
        }
        .titletext {
            color: #444444;
            font-size: large;
            font-weight: bolder;
            text-align: center;
        }
        .monitortext {
            font-size: large;
            font-weight: bolder;
            text-align: right;
        }
        .titletext-connected {
            color: green
        }
        .titletext-disconnected {
            color: red
        }
        .fit-step {
            border-radius: 10px;
            border: 2px solid steelblue;
            background-color: rgb(229, 242, 252);
            margin: 5px;
            padding: 10px;
            /*color: blue*/
        }        
        .fit-step-progress {
            background-color: lightsteelblue;
            border-radius: 10px;
            border: 2px solid steelblue;
            margin: 5px;
            padding: 10px;
            /*color: purple*/
        }        
        .fit-inactive {
            background-color: lightgrey;
            border-radius: 10px;
            border: 2px solid grey;
            margin: 10px;
            padding: 10px;
        }
        .measurement-current {
            font-weight: bold;
            color: green;
            border: 2px solid green;
        }
        .measurement-skipped {
            text-decoration: line-through;
            text-decoration-color: rgb(128, 128, 128);
            color: rgb(128, 128, 128);
        }
        .measurement-pending {
            color: black
        }
        .measurement-done {
            color: chocolate
        }
        .grid-container {
            box-sizing: border-box;
            display: grid;
            grid-template-columns: [col0] minmax(0, 1fr) [col1] minmax(0, 2fr);
            grid-template-rows: [row0] minmax(0, 1fr) [row1] minmax(0, 12fr) [row2] minmax(0, 6fr);
            grid-gap: 20px;
            height: 95%;
        }
        .grid-title {
            /*height: 5vh;*/
            grid-column: col0;
            grid-row: row0;
        }
        .grid-title-right {
            grid-column: col1;
            grid-row: row0;
        }
        .grid-fit {
            grid-column: col0;
            grid-row: row1 / span 2;
            height: 100%
        }
        .grid-progress {
            overflow-y: auto;
            height:100%
            /*min-height: 60vh;
            max-height: 60vh;*/
        }
        .grid-progress-queue {
            overflow-y: auto;
            overflow-x: hidden;
            /*max-height: 30vh;*/
            height:100%;
            border: 2px solid green;
            border-radius: 10px;
            background-color: rgb(209, 250, 230);
            padding: 10px
        }
        .grid-fit-progress-text {
            overflow-y: auto;
            min-height: 5%;
            max-height: 40%;
        }
        .grid-queue {
            grid-column: col1;
            grid-row: row2;
            /*height: 30vh*/
        }
        .grid-plot {
            grid-column: col1;
            grid-row: row1;
            /*height: 30vh;*/
            /*width: 100%;*/
        }
        .plot-frame {
            border-radius: 10px;
            border: 2px solid rgb(107, 70, 180);
            background-color: rgb(220, 206, 248);
            margin: 0px;
            padding: 10px;
            height: 100%;
            width: 100%
        }
        .plot {
            overflow: hidden;
            height:100%;
            width:100%
        }
    </style>
</head>
<body>
    <div class="grid-container">
        <div class="grid-title bigtitletext">
            <em>AutoRefl</em> Monitor
        </div>
        <div id="connect_monitor" class="grid-title-right monitortext titletext-disconnected">
            Disconnected
        </div>
        <div id="fit_progress_container" class="grid-fit">
            <div id="fit_progress_title" class="titletext">Fit Progress</div>
            <div id="fit_progress" class="grid-progress"></div>
        </div>
        <div id="plot_container" class="grid-plot">
            <div id="plot_progress_title" class="titletext">Real Time Plot</div>
            <div id="plot_frame" class="grid-progress plot-frame">
                <div id="plot" class="plot"></div>
            </div>
        </div>
        <div id="queue" class="grid-queue green">
            <div id="queue_title" class="titletext">Measurement Queue</div>
            <div id="queue_text" class="grid-progress-queue"></div>
        </div>
      
    </div>
</body>